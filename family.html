<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firebase Chat with Admin</title>

<!-- Google reCAPTCHA -->
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
  body {
    font-family: Arial;
    max-width: 600px;
    margin: auto;
    padding: 20px;
  }
  #chat {
    border: 1px solid #ccc;
    height: 300px;
    overflow-y: scroll;
    padding: 10px;
    margin-bottom: 10px;
  }
  input {
    padding: 5px;
    margin: 5px 0;
    width: 100%;
  }
  button {
    padding: 6px 10px;
    margin: 5px 0;
  }
  #adminPanel {
    border: 1px solid red;
    padding: 10px;
    margin-bottom: 10px;
  }
</style>
</head>

<body>

<h2>Firebase Chat with Admin</h2>

<!-- AUTH -->
<div id="auth">
  <input id="email" type="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">

  <!-- reCAPTCHA -->
  <div
    class="g-recaptcha"
    data-sitekey="6LeWyVAsAAAAAPLrymJQP1A5dXzdbk9CPoU7RD0w">
  </div>

  <button onclick="signup()">Sign Up</button>
  <button onclick="signin()">Sign In</button>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;">
  <h3>Admin Panel â€“ Approve Users</h3>
  <div id="pendingUsers"></div>
</div>

<!-- CHAT UI -->
<div id="chatUI" style="display:none;">
  <div id="chat"></div>
  <input id="message" placeholder="Type a message">
  <button onclick="sendMessage()">Send</button>
  <button onclick="resetPassword()">Reset Password</button>
</div>

<script type="module">
/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  sendPasswordResetEmail
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot,
  getDocs,
  doc,
  updateDoc,
  where
} from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyB-wNHbLNAsRB3HwblM5yNOHCqs9gBM2T0",
  authDomain: "chat-family-f9f80.firebaseapp.com",
  projectId: "chat-family-f9f80",
  storageBucket: "chat-family-f9f80.firebasestorage.app",
  messagingSenderId: "930576666026",
  appId: "1:930576666026:web:f5caa82ef43d615fd1afd3",
  measurementId: "G-4B9P884Y98"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);

const auth = getAuth(app);
const db = getFirestore(app);

/* ================= CONFIG ================= */
const adminEmail = "winstoncao06@gmail.com";
let currentUserEmail = null;

/* ================= reCAPTCHA CHECK ================= */
function checkRecaptcha() {
  const token = grecaptcha.getResponse();
  if (!token) {
    alert("Please complete the reCAPTCHA.");
    return false;
  }
  return true;
}

/* ================= COOKIE HELPERS ================= */
function setCookie(name, value, days = 1) {
  document.cookie = `${name}=${value}; max-age=${60*60*24*days}; path=/`;
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(";").shift();
}

/* ================= SIGN UP ================= */
async function signup() {
  if (!checkRecaptcha()) return;

  const email = emailInput.value;
  const password = passwordInput.value;

  try {
    await createUserWithEmailAndPassword(auth, email, password);

    await addDoc(collection(db, "users"), {
      email,
      approved: false,
      timestamp: serverTimestamp()
    });

    grecaptcha.reset();
    alert("Account created. Waiting for admin approval.");
  } catch (e) {
    alert(e.message);
  }
}

/* ================= SIGN IN ================= */
async function signin() {
  if (!checkRecaptcha()) return;

  const email = emailInput.value;
  const password = passwordInput.value;

  try {
    await signInWithEmailAndPassword(auth, email, password);

    const q = query(collection(db, "users"), where("email", "==", email));
    const snap = await getDocs(q);

    if (snap.empty) {
      alert("User record not found. Contact admin.");
      return;
    }

    const userData = snap.docs[0].data();
    if (email !== adminEmail && !userData.approved) {
      alert("Waiting for admin approval.");
      return;
    }

    grecaptcha.reset();
    setCookie("chatUser", email);
    currentUserEmail = email;
    showChat();
  } catch (e) {
    alert(e.message);
  }
}

/* ================= SHOW CHAT ================= */
function showChat() {
  authDiv.style.display = "none";
  chatUI.style.display = "block";
  listenMessages();

  if (currentUserEmail === adminEmail) {
    adminPanel.style.display = "block";
    showPendingUsers();
  }
}

/* ================= CHAT ================= */
async function sendMessage() {
  if (!messageInput.value) return;

  await addDoc(collection(db, "chats", "mainChat", "messages"), {
    sender: currentUserEmail,
    text: messageInput.value,
    timestamp: serverTimestamp()
  });

  messageInput.value = "";
}

function listenMessages() {
  const q = query(
    collection(db, "chats", "mainChat", "messages"),
    orderBy("timestamp")
  );

  onSnapshot(q, snap => {
    chat.innerHTML = "";
    snap.forEach(d => {
      const m = d.data();
      chat.innerHTML += `<b>${m.sender}:</b> ${m.text}<br>`;
    });
    chat.scrollTop = chat.scrollHeight;
  });
}

/* ================= RESET PASSWORD ================= */
async function resetPassword() {
  if (!currentUserEmail) {
    alert("You must be logged in.");
    return;
  }

  try {
    await sendPasswordResetEmail(auth, currentUserEmail);
    alert("Password reset email sent.");
  } catch (e) {
    alert(e.message);
  }
}

/* ================= ADMIN ================= */
async function showPendingUsers() {
  const q = query(collection(db, "users"), where("approved", "==", false));
  const snap = await getDocs(q);

  pendingUsers.innerHTML = "";
  snap.forEach(d => {
    const u = d.data();
    const btn = document.createElement("button");
    btn.textContent = `Approve ${u.email}`;
    btn.onclick = async () => {
      await updateDoc(doc(db, "users", d.id), { approved: true });
      showPendingUsers();
    };
    pendingUsers.appendChild(btn);
    pendingUsers.appendChild(document.createElement("br"));
  });
}

/* ================= AUTO LOGIN ================= */
window.onload = () => {
  const email = getCookie("chatUser");
  if (email) {
    currentUserEmail = email;
    showChat();
  }
};

/* ================= ELEMENTS ================= */
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const messageInput = document.getElementById("message");
const chat = document.getElementById("chat");
const authDiv = document.getElementById("auth");
const chatUI = document.getElementById("chatUI");
const adminPanel = document.getElementById("adminPanel");
const pendingUsers = document.getElementById("pendingUsers");

/* ================= GLOBAL ================= */
window.signup = signup;
window.signin = signin;
window.sendMessage = sendMessage;
window.resetPassword = resetPassword;
</script>

</body>
</html>
